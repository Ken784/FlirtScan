# æ­£ç¢ºçš„å»£å‘Šæµç¨‹èªªæ˜

## æ›´æ–°æ—¥æœŸ
2025-12-10

## é‡è¦ä¿®æ­£

ä¹‹å‰çš„å¯¦ä½œæœ‰ä¸€å€‹**åš´é‡çš„é‚è¼¯éŒ¯èª¤**ï¼š

âŒ **éŒ¯èª¤ç†è§£**ï¼šä»¥ç‚ºå¯ä»¥åœ¨ AnalysisPage ä¸Šæ’­æ”¾å»£å‘Šä¸¦åŒæ™‚é¡¯ç¤ºæƒæå‹•ç•«

âœ… **æ­£ç¢ºç†è§£**ï¼šRewarded Ad æ˜¯**å…¨è¢å¹•æ’­æ”¾**çš„ï¼Œæœƒå®Œå…¨è¦†è“‹ç•«é¢ï¼Œç”¨æˆ¶çœ‹ä¸åˆ°ä»»ä½•å…¶ä»–å…§å®¹

---

## ğŸ¯ æ­£ç¢ºçš„æµç¨‹

### è¦–è¦ºæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    HomePage         â”‚
â”‚                     â”‚
â”‚  [å·²é¸æ“‡åœ–ç‰‡]       â”‚
â”‚  [é–‹å§‹åˆ†æ] â† é»æ“Š  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
         â†“ ç«‹å³æ’­æ”¾å…¨è¢å¹•å»£å‘Š
         â†“ èƒŒå¾Œé–‹å§‹åˆ†æï¼ˆç”¨æˆ¶çœ‹ä¸åˆ°ï¼‰
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Rewarded Ad       â”‚ â† å…¨è¢å¹•å»£å‘Š
â”‚   (æ¸¬è©¦å»£å‘Š)        â”‚   å®Œå…¨è¦†è“‹ç•«é¢
â”‚                     â”‚
â”‚   [X] 5ç§’å¾Œå¯é—œé–‰   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
         â†“ ç”¨æˆ¶çœ‹å®Œå»£å‘Š
         â†“ onUserEarnedReward å›èª¿
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ResultPage        â”‚
â”‚                     â”‚
â”‚   æ­£åœ¨è§£è®€...       â”‚ â† å¦‚æœåˆ†ææœªå®Œæˆ
â”‚   æˆ–                â”‚
â”‚   [é¡¯ç¤ºçµæœ]        â”‚ â† å¦‚æœåˆ†æå·²å®Œæˆ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç¨‹å¼æµç¨‹

```
1. HomePage._startAnalysis()
   â”œâ”€ ref.read(analysisProvider).analyze() // é–‹å§‹èƒŒæ™¯åˆ†æ
   â””â”€ _showAd() // æ’­æ”¾å…¨è¢å¹•å»£å‘Š
      â†“
2. å…¨è¢å¹• Rewarded Ad æ’­æ”¾
   - ç”¨æˆ¶çœ‹ä¸åˆ°ä»»ä½•å…¶ä»–å…§å®¹
   - èƒŒå¾Œåˆ†æåœ¨é€²è¡Œä¸­
      â†“
3. onUserEarnedReward å›èª¿
   - ç”¨æˆ¶çœ‹å®Œå»£å‘Š
   - context.push(ResultPage.route)
      â†“
4. ResultPage
   - ç›£è½ analysisProvider ç‹€æ…‹
   - é¡¯ç¤ºã€Œæ­£åœ¨è§£è®€...ã€æˆ–çµæœ
```

---

## ğŸ“ å·²åˆªé™¤çš„æª”æ¡ˆ

### âŒ `lib/src/pages/analysis_page.dart`

**ç‚ºä»€éº¼åˆªé™¤ï¼Ÿ**
- Rewarded Ad æ˜¯å…¨è¢å¹•çš„ï¼Œæœƒå®Œå…¨è¦†è“‹ç•«é¢
- ç”¨æˆ¶çœ‹ä¸åˆ° AnalysisPage çš„æƒæå‹•ç•«
- é€™å€‹é é¢å®Œå…¨æ²’æœ‰å­˜åœ¨çš„å¿…è¦

---

## ğŸ”§ ä¿®æ”¹çš„æª”æ¡ˆ

### 1. `lib/src/pages/home_page.dart`

#### æ–°å¢ imports
```dart
import '../core/providers/analysis_provider.dart';
import '../services/ad_service.dart';
import 'result_page.dart';
```

#### ä¿®æ”¹ `_startAnalysis()` æ–¹æ³•

```dart
/// é–‹å§‹åˆ†æå°è©±
Future<void> _startAnalysis() async {
  if (_preparedBase64String == null || _isAnalyzing) return;

  setState(() {
    _isAnalyzing = true;
  });

  try {
    // 1. ä½¿ç”¨ analysisProvider é–‹å§‹èƒŒæ™¯åˆ†æ
    ref.read(analysisProvider.notifier).analyze(_preparedBase64String!);
    
    // 2. ç›£è½åˆ†æéŒ¯èª¤
    ref.listen(analysisProvider, (previous, next) {
      if (next.hasError && mounted) {
        ref.read(errorProvider.notifier).showError(
          next.errorMessage ?? 'åˆ†æéç¨‹ç™¼ç”ŸéŒ¯èª¤',
          title: 'åˆ†æå¤±æ•—',
        );
        setState(() {
          _isAnalyzing = false;
        });
      }
    });

    // 3. æ’­æ”¾å…¨è¢å¹•å»£å‘Š
    await _showAd();
    
    setState(() {
      _isAnalyzing = false;
    });
  } catch (e) {
    // éŒ¯èª¤è™•ç†...
  }
}
```

#### æ–°å¢ `_showAd()` æ–¹æ³•

```dart
/// é¡¯ç¤ºå…¨è¢å¹•çå‹µå»£å‘Š
Future<void> _showAd() async {
  final adService = AdService();
  
  // æª¢æŸ¥å»£å‘Šæ˜¯å¦å·²è¼‰å…¥
  if (!adService.isAdLoaded) {
    if (mounted) {
      ref.read(errorProvider.notifier).showError(
        'å»£å‘Šè¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦',
        title: 'åˆ†æå¤±æ•—',
      );
    }
    return;
  }

  // é¡¯ç¤ºå…¨è¢å¹•çå‹µå»£å‘Š
  await adService.showRewardedAd(
    onUserEarnedReward: () {
      // ç”¨æˆ¶çœ‹å®Œå»£å‘Šï¼Œè·³è½‰åˆ° ResultPage
      debugPrint('å»£å‘Šæ’­æ”¾å®Œæˆï¼Œè·³è½‰åˆ°çµæœé é¢');
      if (mounted) {
        context.push(
          '${ResultPage.route}?imageBase64=${Uri.encodeComponent(_preparedBase64String!)}',
        );
      }
    },
    onAdDismissed: () {
      debugPrint('å»£å‘Šè¢«é—œé–‰');
    },
    onAdFailedToShow: () {
      // å»£å‘Šæ’­æ”¾å¤±æ•—
      if (mounted) {
        ref.read(errorProvider.notifier).showError(
          'å»£å‘Šè¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦',
          title: 'åˆ†æå¤±æ•—',
        );
      }
    },
  );
}
```

---

### 2. `lib/src/core/config/app_router.dart`

#### ç§»é™¤ AnalysisPage ç›¸é—œä»£ç¢¼

```dart
// âŒ åˆªé™¤é€™å€‹ import
import '../../pages/analysis_page.dart';

// âŒ åˆªé™¤é€™å€‹è·¯ç”±
GoRoute(
  path: AnalysisPage.route,
  builder: (context, state) {
    final imageBase64 = state.uri.queryParameters['imageBase64'];
    return AnalysisPage(imageBase64: imageBase64);
  },
),
```

---

## âœ… å„ªé»

### 1. é‚è¼¯æ­£ç¢º
- âœ… ç¬¦åˆ Rewarded Ad çš„å…¨è¢å¹•ç‰¹æ€§
- âœ… ä¸æœƒæœ‰ã€Œçœ‹ä¸è¦‹çš„é é¢ã€

### 2. ç”¨æˆ¶é«”é©—
- âœ… æµç¨‹ç°¡å–®æ˜ç¢º
- âœ… çœ‹å®Œå»£å‘Šç«‹å³è·³è½‰
- âœ… åˆ†æåœ¨èƒŒæ™¯é€²è¡Œï¼Œç”¨æˆ¶ç„¡æ„Ÿ

### 3. ç¨‹å¼ç¢¼ç°¡æ½”
- âœ… æ¸›å°‘ä¸€å€‹ä¸å¿…è¦çš„é é¢
- âœ… é‚è¼¯é›†ä¸­åœ¨ HomePage
- âœ… æ›´å®¹æ˜“ç¶­è­·

---

## ğŸ¬ å®Œæ•´çš„ç”¨æˆ¶é«”é©—

### æ™‚é–“è»¸

```
T=0s    ç”¨æˆ¶é»æ“Šã€Œé–‹å§‹åˆ†æã€
        â†“
T=0.1s  å…¨è¢å¹•å»£å‘Šå½ˆå‡ºï¼ˆè¦†è“‹æ•´å€‹ç•«é¢ï¼‰
        èƒŒå¾Œé–‹å§‹å‘¼å« OpenAI API
        â†“
T=5s    ç”¨æˆ¶å¯ä»¥é—œé–‰å»£å‘Š
        â†“
T=10s   ç”¨æˆ¶é—œé–‰å»£å‘Š
        ç«‹å³è·³è½‰åˆ° ResultPage
        â†“
T=10.1s ResultPage é¡¯ç¤ºã€Œæ­£åœ¨è§£è®€...ã€
        ï¼ˆå› ç‚ºåˆ†æå¯èƒ½é‚„æ²’å®Œæˆï¼‰
        â†“
T=15s   åˆ†æå®Œæˆ
        ResultPage è‡ªå‹•æ›´æ–°é¡¯ç¤ºçµæœ
```

### é—œéµæ™‚é–“é»

- **å»£å‘Šæ™‚é•·**ï¼šé€šå¸¸ 5-30 ç§’
- **åˆ†ææ™‚é•·**ï¼šé€šå¸¸ 10-30 ç§’ï¼ˆå–æ±ºæ–¼ OpenAI API é€Ÿåº¦ï¼‰
- **é‡ç–Šæ™‚é–“**ï¼šå»£å‘Šå’Œåˆ†æåŒæ™‚é€²è¡Œï¼Œç¯€çœç”¨æˆ¶ç­‰å¾…æ™‚é–“

---

## ğŸ” æŠ€è¡“ç´°ç¯€

### 1. ç‚ºä»€éº¼è¦åœ¨ HomePage æ’­æ”¾å»£å‘Šï¼Ÿ

å› ç‚ºï¼š
- Rewarded Ad æ˜¯å…¨è¢å¹•çš„
- æ’­æ”¾æ™‚æœƒè¦†è“‹æ•´å€‹ç•«é¢
- ä¸éœ€è¦é¡å¤–çš„é é¢ä¾†ã€Œæ‰¿è¼‰ã€å»£å‘Š

### 2. åˆ†æä»€éº¼æ™‚å€™é–‹å§‹ï¼Ÿ

```dart
// åœ¨æ’­æ”¾å»£å‘Šä¹‹å‰å°±é–‹å§‹åˆ†æ
ref.read(analysisProvider.notifier).analyze(_preparedBase64String!);
await _showAd(); // å»£å‘Šæ’­æ”¾æ™‚ï¼Œåˆ†æåœ¨èƒŒå¾Œé€²è¡Œ
```

### 3. ResultPage å¦‚ä½•çŸ¥é“åˆ†æç‹€æ…‹ï¼Ÿ

```dart
// ResultPage ç›£è½å…¨å±€ analysisProvider
final analysisState = ref.watch(analysisProvider);

return analysisState.isAnalyzing
    ? _buildAnalyzingView()      // é¡¯ç¤ºã€Œæ­£åœ¨è§£è®€...ã€
    : analysisState.result != null
        ? _buildResultView()      // é¡¯ç¤ºçµæœ
        : _buildEmptyView();
```

### 4. å¦‚æœåˆ†ææ¯”å»£å‘Šå¿«ï¼Ÿ

æ²’å•é¡Œï¼
- å»£å‘Šæ’­æ”¾å®Œæˆå¾Œï¼ŒResultPage æœƒç«‹å³é¡¯ç¤ºçµæœ
- ä¸æœƒæœ‰é¡å¤–çš„ç­‰å¾…æ™‚é–“

### 5. å¦‚æœå»£å‘Šæ¯”åˆ†æå¿«ï¼Ÿ

ä¹Ÿæ²’å•é¡Œï¼
- ResultPage æœƒé¡¯ç¤ºã€Œæ­£åœ¨è§£è®€...ã€å‹•ç•«
- åˆ†æå®Œæˆå¾Œè‡ªå‹•æ›´æ–°é¡¯ç¤ºçµæœ

---

## ğŸ§ª æ¸¬è©¦æª¢æŸ¥æ¸…å–®

### åŸºæœ¬æµç¨‹
- [ ] é»æ“Šã€Œé–‹å§‹åˆ†æã€å¾Œï¼Œç«‹å³å½ˆå‡ºå…¨è¢å¹•å»£å‘Š
- [ ] å»£å‘Šæ’­æ”¾æ™‚ï¼Œçœ‹ä¸åˆ°ä»»ä½•å…¶ä»–å…§å®¹
- [ ] çœ‹å®Œå»£å‘Šå¾Œï¼Œç«‹å³è·³è½‰åˆ° ResultPage
- [ ] ResultPage é¡¯ç¤ºã€Œæ­£åœ¨è§£è®€...ã€æˆ–çµæœ

### éŒ¯èª¤è™•ç†
- [ ] å»£å‘Šè¼‰å…¥å¤±æ•—æ™‚ï¼Œé¡¯ç¤ºéŒ¯èª¤é®ç½©
- [ ] åˆ†æå¤±æ•—æ™‚ï¼Œè·³å› HomePage ä¸¦é¡¯ç¤ºéŒ¯èª¤
- [ ] ç”¨æˆ¶æå‰é—œé–‰å»£å‘Šï¼ˆæ²’çœ‹å®Œï¼‰ï¼Œä¸æœƒè·³è½‰

### æ•ˆèƒ½
- [ ] åªæœ‰ 1 æ¬¡ API èª¿ç”¨ï¼ˆæª¢æŸ¥ Firebase Consoleï¼‰
- [ ] å»£å‘Šå’Œåˆ†æåŒæ™‚é€²è¡Œ
- [ ] æ²’æœ‰ä¸å¿…è¦çš„é é¢è·³è½‰

---

## ğŸ“Š èˆ‡ä¹‹å‰çš„å°æ¯”

### ä¹‹å‰çš„éŒ¯èª¤å¯¦ä½œ âŒ

```
HomePage
  â†“ è·³è½‰
AnalysisPage (é¡¯ç¤ºå‹•ç•« + æ’­æ”¾å»£å‘Š) â† é‚è¼¯éŒ¯èª¤ï¼
  â†“ å»£å‘Šå®Œæˆå¾Œç­‰å¾…
  â†“ åˆ†æå®Œæˆ
ResultPage
```

**å•é¡Œï¼š**
- AnalysisPage çš„å‹•ç•«ç”¨æˆ¶æ ¹æœ¬çœ‹ä¸åˆ°ï¼ˆè¢«å»£å‘Šè¦†è“‹ï¼‰
- å¤šäº†ä¸€å€‹ä¸å¿…è¦çš„é é¢
- é‚è¼¯æ··äº‚

### ç¾åœ¨çš„æ­£ç¢ºå¯¦ä½œ âœ…

```
HomePage
  â”œâ”€ é–‹å§‹åˆ†æï¼ˆèƒŒæ™¯ï¼‰
  â””â”€ æ’­æ”¾å…¨è¢å¹•å»£å‘Š
       â†“ å»£å‘Šå®Œæˆ
ResultPage (ç›£è½åˆ†æç‹€æ…‹)
```

**å„ªé»ï¼š**
- é‚è¼¯æ¸…æ™°
- ç¬¦åˆ Rewarded Ad çš„ç‰¹æ€§
- ç¨‹å¼ç¢¼ç°¡æ½”

---

## ğŸ¯ ç¸½çµ

### é—œéµç†è§£

**Rewarded Ad æ˜¯å…¨è¢å¹•æ’­æ”¾çš„**
- æœƒå®Œå…¨è¦†è“‹ç•«é¢
- ç”¨æˆ¶çœ‹ä¸åˆ°ä»»ä½•å…¶ä»–å…§å®¹
- ä¸éœ€è¦é¡å¤–çš„é é¢ä¾†ã€Œæ‰¿è¼‰ã€å»£å‘Š

### æ­£ç¢ºçš„åšæ³•

1. åœ¨ HomePage é»æ“Šåˆ†æ
2. ç«‹å³é–‹å§‹èƒŒæ™¯åˆ†æ
3. ç«‹å³æ’­æ”¾å…¨è¢å¹•å»£å‘Š
4. å»£å‘Šå®Œæˆå¾Œè·³è½‰åˆ° ResultPage
5. ResultPage ç›£è½åˆ†æç‹€æ…‹ä¸¦é¡¯ç¤º

### ç‚ºä»€éº¼é€™æ¨£åšæ˜¯å°çš„

- âœ… ç¬¦åˆ Rewarded Ad çš„å·¥ä½œåŸç†
- âœ… ç”¨æˆ¶é«”é©—æµæš¢
- âœ… ç¨‹å¼ç¢¼ç°¡æ½”æ˜“ç¶­è­·
- âœ… ç¯€çœ API èª¿ç”¨æ¬¡æ•¸

---

**ä¿®æ”¹å®Œæˆ**ï¼Œå¯ä»¥é–‹å§‹æ¸¬è©¦ï¼ğŸ‰


