# 進階逐句分析測試指南

## 更新日期
2025-12-10

---

## 🎯 測試目標

驗證進階逐句分析功能的完整流程，包括：
1. 廣告解鎖機制
2. 逐句分析資料顯示
3. 解鎖狀態持久化
4. 錯誤處理

---

## 📋 測試前準備

### 1. 確認廣告服務已初始化

檢查 `main.dart` 中是否有：

```dart
await AdService.initialize();
```

### 2. 確認使用測試廣告 ID

在 `lib/src/services/ad_service.dart` 中確認：

```dart
static String get rewardedAdUnitId {
  if (defaultTargetPlatform == TargetPlatform.android) {
    return 'ca-app-pub-3940256099942544/5224354917'; // Android 測試 ID
  } else if (defaultTargetPlatform == TargetPlatform.iOS) {
    return 'ca-app-pub-3940256099942544/1712485313'; // iOS 測試 ID
  }
  return '';
}
```

### 3. 準備測試圖片

準備一張包含對話記錄的截圖，確保：
- 圖片清晰可讀
- 包含至少 2-3 句對話
- 對話內容適合分析

---

## 🧪 測試案例

### 測試案例 1：首次解鎖進階分析

**目的**：驗證首次點擊「進階逐句分析」按鈕會播放廣告

**步驟**：
1. 啟動 App
2. 上傳對話截圖
3. 點擊「開始分析」按鈕
4. 看完第一支廣告（初步分析）
5. 等待分析完成，顯示結果頁面
6. 點擊「進階逐句分析」按鈕

**預期結果**：
- ✅ 顯示「廣告載入中，請稍候...」提示（如果廣告未載入）
- ✅ 播放第二支 Rewarded Ad（全螢幕）
- ✅ 廣告可以在 5 秒後關閉
- ✅ 看完廣告後自動跳轉到逐句分析頁面

**實際結果**：
- [ ] 通過
- [ ] 失敗（原因：_____________）

---

### 測試案例 2：逐句分析資料顯示

**目的**：驗證逐句分析頁面正確顯示資料

**步驟**：
1. 延續測試案例 1
2. 進入逐句分析頁面

**預期結果**：
- ✅ 頁面標題顯示「逐句分析」
- ✅ 顯示所有對話句子（至少 2-3 句）
- ✅ 每句對話包含：
  - 原始對話內容（帶引號）
  - 背後含意
  - 曖昧指數（星級顯示）
  - 評分百分比
  - 評分理由
- ✅ 對話卡片根據發話者顯示不同顏色：
  - Partner（對方）：黃色背景 (`#FFFEC0`)
  - Me（我）：藍色背景 (`#D9F4FF`)
- ✅ 底部顯示進階總結卡片（藍色邊框）
- ✅ 顯示截圖按鈕

**實際結果**：
- [ ] 通過
- [ ] 失敗（原因：_____________）

---

### 測試案例 3：解鎖狀態持久化

**目的**：驗證解鎖後再次進入不需要看廣告

**步驟**：
1. 延續測試案例 2
2. 點擊返回按鈕，回到結果頁面
3. 再次點擊「進階逐句分析」按鈕

**預期結果**：
- ✅ **不播放廣告**
- ✅ 直接跳轉到逐句分析頁面
- ✅ 資料顯示正常

**實際結果**：
- [ ] 通過
- [ ] 失敗（原因：_____________）

---

### 測試案例 4：廣告載入失敗處理

**目的**：驗證廣告載入失敗時的錯誤處理

**步驟**：
1. 關閉網路連線（飛航模式）
2. 啟動 App
3. 上傳對話截圖並完成分析
4. 點擊「進階逐句分析」按鈕

**預期結果**：
- ✅ 顯示「廣告載入中，請稍候...」提示
- ✅ 等待一段時間後顯示「廣告載入失敗，請稍後再試」
- ✅ 按鈕恢復可點擊狀態
- ✅ 不會跳轉到逐句分析頁面

**實際結果**：
- [ ] 通過
- [ ] 失敗（原因：_____________）

---

### 測試案例 5：廣告播放中途關閉

**目的**：驗證用戶未看完廣告的處理

**步驟**：
1. 啟動 App
2. 上傳對話截圖並完成分析
3. 點擊「進階逐句分析」按鈕
4. 廣告開始播放後，立即點擊關閉按鈕（不等 5 秒）

**預期結果**：
- ✅ 廣告關閉
- ✅ 返回結果頁面
- ✅ **不解鎖進階分析**（因為沒看完）
- ✅ 再次點擊「進階逐句分析」按鈕仍會播放廣告

**實際結果**：
- [ ] 通過
- [ ] 失敗（原因：_____________）

---

### 測試案例 6：沒有分析結果時的錯誤處理

**目的**：驗證沒有分析結果時的錯誤頁面

**步驟**：
1. 直接在瀏覽器輸入 `/result-sentence` 路徑
2. 或清空 `analysisProvider` 狀態後進入逐句分析頁面

**預期結果**：
- ✅ 顯示「沒有分析結果」訊息
- ✅ 顯示「返回」按鈕
- ✅ 點擊返回按鈕可以返回上一頁

**實際結果**：
- [ ] 通過
- [ ] 失敗（原因：_____________）

---

### 測試案例 7：多句對話的顯示

**目的**：驗證多句對話的正確顯示和排版

**步驟**：
1. 準備一張包含 5 句以上對話的截圖
2. 上傳並完成分析
3. 進入逐句分析頁面

**預期結果**：
- ✅ 所有對話按順序顯示
- ✅ 對話卡片之間有適當間距
- ✅ 可以捲動查看所有對話
- ✅ 進階總結卡片在最後
- ✅ 截圖按鈕在最底部

**實際結果**：
- [ ] 通過
- [ ] 失敗（原因：_____________）

---

### 測試案例 8：對話者識別

**目的**：驗證 Me/Partner 的正確識別和顯示

**步驟**：
1. 上傳包含明確「我」和「對方」對話的截圖
2. 完成分析並進入逐句分析頁面

**預期結果**：
- ✅ 「我」的對話顯示藍色背景，右對齊
- ✅ 「對方」的對話顯示黃色背景，左對齊
- ✅ 對話者識別正確（與實際對話內容相符）

**實際結果**：
- [ ] 通過
- [ ] 失敗（原因：_____________）

---

## 🐛 已知問題

### 問題 1：廣告載入時間過長

**現象**：點擊「進階逐句分析」後需要等待較長時間

**原因**：廣告未預載

**解決方案**：
- 在 `ResultPage` 的 `initState` 中預載第二支廣告
- 或在第一支廣告播放完成後立即預載第二支廣告

**優先級**：中

---

### 問題 2：快速點擊按鈕導致多次播放廣告

**現象**：快速點擊「進階逐句分析」按鈕可能導致多次播放廣告

**原因**：按鈕未禁用

**解決方案**：
- 已實作 `_isLoadingAd` 狀態來禁用按鈕
- 確認 `onPressed: _isLoadingAd ? null : () => _handleAdvancedAnalysis(result)`

**優先級**：低（已解決）

---

## 📊 測試結果總結

| 測試案例 | 通過 | 失敗 | 備註 |
|---------|------|------|------|
| 1. 首次解鎖進階分析 | [ ] | [ ] | |
| 2. 逐句分析資料顯示 | [ ] | [ ] | |
| 3. 解鎖狀態持久化 | [ ] | [ ] | |
| 4. 廣告載入失敗處理 | [ ] | [ ] | |
| 5. 廣告播放中途關閉 | [ ] | [ ] | |
| 6. 沒有分析結果時的錯誤處理 | [ ] | [ ] | |
| 7. 多句對話的顯示 | [ ] | [ ] | |
| 8. 對話者識別 | [ ] | [ ] | |

**總通過率**：_____ / 8

---

## 🔍 除錯技巧

### 1. 檢查廣告載入狀態

在 `ResultPage` 的 `_handleAdvancedAnalysis` 方法中加入：

```dart
debugPrint('AdService.isAdLoaded: ${_adService.isAdLoaded}');
```

### 2. 檢查解鎖狀態

在 `ResultPage` 的 `_buildResultView` 方法中加入：

```dart
debugPrint('isAdvancedUnlocked: ${result.isAdvancedUnlocked}');
```

### 3. 檢查逐句分析資料

在 `ResultSentencePage` 的 `build` 方法中加入：

```dart
debugPrint('sentences count: ${result.sentences.length}');
for (var sentence in result.sentences) {
  debugPrint('${sentence.speaker}: ${sentence.originalText}');
}
```

### 4. 檢查廣告回調

在 `_handleAdvancedAnalysis` 的廣告回調中加入：

```dart
onUserEarnedReward: () {
  debugPrint('✅ onUserEarnedReward called');
  // ...
},
onAdDismissed: () {
  debugPrint('✅ onAdDismissed called');
  // ...
},
```

---

## 📝 測試注意事項

1. **測試環境**：
   - 使用測試廣告 ID
   - 確保網路連線正常
   - 使用真實裝置測試（模擬器可能無法正常載入廣告）

2. **資料準備**：
   - 準備多種對話截圖（2-3 句、5 句以上）
   - 準備包含 emoji 的對話
   - 準備不同語氣的對話（正式、輕鬆、曖昧）

3. **測試順序**：
   - 先測試正常流程（測試案例 1-3）
   - 再測試錯誤處理（測試案例 4-6）
   - 最後測試邊界情況（測試案例 7-8）

4. **測試記錄**：
   - 記錄每個測試案例的實際結果
   - 截圖保存錯誤畫面
   - 記錄 console 輸出的 debug 訊息

---

## 🎯 下一步

完成測試後：
1. 修復發現的問題
2. 更新測試結果
3. 準備上線前的最終測試
4. 撰寫使用者文件

---

## 📚 相關文件

- [進階逐句分析實作說明.md](./進階逐句分析實作說明.md)
- [正確的廣告流程說明.md](./正確的廣告流程說明.md)
- [測試指南.md](./測試指南.md)


