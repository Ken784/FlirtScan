# 錯誤處理流程更新

## 更新日期
2025-12-10

## 變更內容

根據您的需求，已將錯誤處理流程修改為：
- ✅ 錯誤發生時**立即跳回 HomePage**
- ✅ HomePage 上面顯示**黑色半透明遮罩**
- ✅ 在遮罩上面顯示錯誤訊息對話框

## 新增檔案

### 1. `lib/src/core/providers/error_provider.dart`

創建了全局的錯誤狀態管理 Provider，使用 Riverpod 來管理錯誤狀態。

**功能：**
- `ErrorState`: 錯誤狀態類，包含錯誤訊息和標題
- `ErrorNotifier`: 狀態管理器，提供顯示/清除錯誤的方法
- `errorProvider`: 全局 Provider，可在任何頁面訪問

**使用方式：**

```dart
// 顯示錯誤
ref.read(errorProvider.notifier).showError(
  '請上傳一對一對話截圖',
  title: '分析失敗',
);

// 清除錯誤
ref.read(errorProvider.notifier).clearError();

// 監聽錯誤狀態
final errorState = ref.watch(errorProvider);
if (errorState.hasError) {
  // 顯示錯誤 UI
}
```

## 修改的檔案

### 1. `lib/src/pages/analysis_page.dart`

**變更：**
- 從 `StatefulWidget` 改為 `ConsumerStatefulWidget`
- 添加 `error_provider` 導入
- 修改 `_showError` 方法：
  - 不再顯示 Dialog
  - 使用 `errorProvider` 設置錯誤狀態
  - 立即使用 `context.go(HomePage.route)` 跳回 HomePage

**錯誤處理流程：**

```dart
void _showError(String message) {
  if (_hasError) return;
  
  setState(() {
    _hasError = true;
  });

  // 設置錯誤狀態
  ref.read(errorProvider.notifier).showError(
    message,
    title: AppLocalizations.of(context)!.errorTitle,
  );

  // 立即返回 HomePage
  if (mounted) {
    context.go(HomePage.route);
  }
}
```

### 2. `lib/src/pages/home_page.dart`

**變更：**
- 從 `StatefulWidget` 改為 `ConsumerStatefulWidget`
- 添加必要的導入（`flutter_riverpod`, `error_provider`, `error_dialog` 等）
- 修改 `build` 方法：
  - 使用 `Stack` 包裹主要內容
  - 監聽 `errorProvider` 狀態
  - 當有錯誤時顯示遮罩和對話框
- 新增 `_buildErrorOverlay` 方法來建立錯誤遮罩

**錯誤遮罩實現：**

```dart
@override
Widget build(BuildContext context) {
  // 監聽錯誤狀態
  final errorState = ref.watch(errorProvider);
  
  return Stack(
    children: [
      // 主要內容（Scaffold）
      Scaffold(...),
      
      // 錯誤遮罩和對話框
      if (errorState.hasError)
        _buildErrorOverlay(errorState),
    ],
  );
}

Widget _buildErrorOverlay(ErrorState errorState) {
  return Container(
    color: Colors.black.withOpacity(0.5), // 黑色半透明遮罩
    child: Center(
      child: ErrorDialog(
        title: errorState.title ?? AppLocalizations.of(context)!.errorTitle,
        message: errorState.message!,
        buttonText: AppLocalizations.of(context)!.ok,
        onPressed: () {
          // 清除錯誤，關閉遮罩
          ref.read(errorProvider.notifier).clearError();
        },
      ),
    ),
  );
}
```

## 視覺效果

### 之前的流程 ❌
```
AnalysisPage（分析中）
    ↓ 錯誤發生
AnalysisPage + 錯誤 Dialog（浮動對話框）
    ↓ 點擊確定
HomePage
```

### 現在的流程 ✅
```
AnalysisPage（分析中）
    ↓ 錯誤發生（立即跳轉）
HomePage（正常頁面）
    ↓ 同時顯示
HomePage + 黑色半透明遮罩 + 錯誤對話框
    ↓ 點擊確定
HomePage（遮罩消失，恢復正常）
```

## UI 層次結構

```
Stack
├─ Scaffold (HomePage 主要內容)
│  ├─ Container (漸層背景)
│  │  └─ SafeArea
│  │     └─ Column
│  │        ├─ PageHeader (標題欄)
│  │        └─ Expanded (主要內容)
│  └─ BottomNav (底部導航)
└─ Container (錯誤遮罩) ← 只在有錯誤時顯示
   └─ ErrorDialog (錯誤對話框)
```

## 優點

1. **更好的用戶體驗**
   - 用戶回到熟悉的 HomePage
   - 黑色遮罩清楚表示這是一個模態提示
   - 視覺層次清晰

2. **狀態管理清晰**
   - 使用 Riverpod 統一管理錯誤狀態
   - 任何頁面都可以觸發錯誤
   - 集中在 HomePage 顯示，避免重複代碼

3. **易於擴展**
   - 未來可以在其他頁面也使用相同的錯誤機制
   - 可以輕鬆添加不同類型的錯誤樣式
   - 可以添加錯誤追蹤和日誌

## 錯誤類型和訊息

根據 `app_localizations`，目前支援的錯誤訊息：

1. `errorNotOneOnOneChat`: "請上傳一對一對話截圖"
2. `errorAdNotLoaded`: "廣告載入失敗，請稍後再試"
3. `errorAnalysisFailed`: "分析過程發生錯誤，請重試"

## 測試檢查清單

- [ ] 上傳無效圖片，確認錯誤出現在 HomePage 上
- [ ] 確認黑色半透明遮罩覆蓋整個 HomePage
- [ ] 確認錯誤對話框在遮罩中央顯示
- [ ] 點擊「確定」按鈕後，遮罩消失
- [ ] 確認 HomePage 狀態保持不變（例如已選擇的圖片）
- [ ] 測試廣告載入失敗的情況
- [ ] 測試分析失敗的情況

## 注意事項

1. **HomePage 必須是 ConsumerStatefulWidget**
   - 需要使用 `ref.watch()` 監聽狀態
   - 需要使用 `ref.read()` 修改狀態

2. **遮罩層級**
   - 使用 `Stack` 確保遮罩在最上層
   - 遮罩應該覆蓋包括 BottomNav 在內的所有內容

3. **狀態清理**
   - 點擊確定時必須調用 `clearError()`
   - 避免錯誤狀態殘留

4. **多次錯誤**
   - 錯誤狀態會被覆寫，只顯示最新的錯誤
   - 如需要顯示多個錯誤，可修改 `ErrorState` 為列表

## 相容性

- ✅ 與現有的廣告流程完全相容
- ✅ 不影響正常的分析流程
- ✅ 不影響其他頁面的功能
- ✅ 向後相容，不需要修改其他代碼

## 未來改進建議

1. **錯誤動畫**
   - 添加遮罩淡入淡出動畫
   - 添加對話框彈出動畫

2. **錯誤類型區分**
   - 不同錯誤類型使用不同的圖標
   - 嚴重錯誤使用紅色，警告使用黃色

3. **錯誤追蹤**
   - 整合 Firebase Crashlytics
   - 記錄錯誤發生的上下文

4. **自動消失**
   - 某些非關鍵錯誤可以設置自動消失
   - 添加倒數計時功能

---

**修改完成**，可以開始測試！

