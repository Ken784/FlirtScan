# Google Mobile Ads 整合說明

## 功能概述

已成功整合 Google Mobile Ads，實作獎勵廣告（Rewarded Ad）流程：

### 流程說明

1. **HomeScreen 點擊分析**
   - 用戶點擊「開始分析」按鈕
   - 立即跳轉至 `AnalysisPage`
   - 背後同時進行兩件事：
     - 呼叫 Firebase Functions 分析截圖
     - 播放獎勵廣告

2. **分析過程中播放廣告**
   - 畫面顯示「正在揣摩他/她的心思...」的掃描動畫
   - 全螢幕播放 Rewarded Ad（測試廣告）

3. **廣告回調處理**
   - **成功看完廣告（onUserEarnedReward）**：等待分析完成後，自動跳轉至 `ResultPage` 顯示結果
   - **廣告播放失敗**：顯示錯誤對話框，返回 HomePage

4. **錯誤處理**
   - 分析過程中發生錯誤（例如非一對一對話截圖）
   - 立即停止流程，顯示錯誤對話框（參考 Figma 設計）
   - 關閉對話框後返回 HomePage

## 檔案結構

### 新增檔案

1. **`lib/src/services/ad_service.dart`**
   - 封裝 Google Mobile Ads SDK
   - 管理獎勵廣告的載入和顯示
   - 提供廣告狀態查詢和回調處理

2. **`lib/src/widgets/error_dialog.dart`**
   - 自訂錯誤對話框 Widget
   - 參考 Figma 設計：深色主題、圓角、iOS 風格
   - 可重複使用的錯誤提示組件

### 修改檔案

1. **`lib/main.dart`**
   - 初始化 Google Mobile Ads SDK
   - 預載第一個獎勵廣告

2. **`lib/src/pages/analysis_page.dart`**
   - 完全重寫，接收 `imageBase64` 參數
   - 同時執行分析和播放廣告
   - 處理各種錯誤情況

3. **`lib/src/pages/home_page.dart`**
   - 修改 `_startAnalysis()` 方法
   - 改為跳轉至 `AnalysisPage` 而非直接分析

4. **`lib/src/core/config/app_router.dart`**
   - 更新 `AnalysisPage` 路由配置
   - 支援 `imageBase64` 查詢參數

5. **本地化檔案**
   - `lib/l10n/app_zh.arb`
   - `lib/l10n/app_zh_TW.arb`
   - 新增廣告相關的文字

### 配置檔案

1. **`pubspec.yaml`**
   - 新增 `google_mobile_ads: ^5.1.0` 依賴

2. **`ios/Runner/Info.plist`**
   - 新增 `GADApplicationIdentifier`（測試 App ID）
   - 新增 `SKAdNetworkItems` 陣列

3. **`android/app/src/main/AndroidManifest.xml`**
   - 新增 Google Mobile Ads App ID meta-data（測試 ID）

## 測試廣告 ID

目前使用 Google 提供的測試廣告 ID：

- **Android 獎勵廣告**：`ca-app-pub-3940256099942544/5224354917`
- **iOS 獎勵廣告**：`ca-app-pub-3940256099942544/1712485313`
- **Android App ID**：`ca-app-pub-3940256099942544~3347511713`
- **iOS App ID**：`ca-app-pub-3940256099942544~1458002511`

⚠️ **重要**：上線前必須替換為正式的 AdMob 廣告單元 ID！

## 錯誤對話框設計

參考 Figma 設計：https://www.figma.com/design/Z2YBZJO8AEbauRkU6YuwRQ/Flirt-Analysis?node-id=139-344

特點：
- 深灰色背景 (`#2C2C2E`)
- 圓角 14px
- 標題 + 訊息 + 按鈕
- iOS 風格分隔線
- 支援自訂按鈕文字和回調

## 使用方式

### 顯示錯誤對話框

```dart
import '../widgets/error_dialog.dart';
import '../l10n/app_localizations.dart';

showErrorDialog(
  context,
  title: AppLocalizations.of(context)!.errorTitle,
  message: AppLocalizations.of(context)!.errorNotOneOnOneChat,
  buttonText: AppLocalizations.of(context)!.ok,
  onPressed: () {
    Navigator.of(context).pop();
    // 其他處理...
  },
);
```

### 檢查廣告狀態

```dart
final adService = AdService();

if (adService.isAdLoaded) {
  // 廣告已載入，可以顯示
}

if (adService.isAdShowing) {
  // 廣告正在顯示中
}
```

## 測試檢查條件

✅ **必須看完測試廣告才能進入結果頁**

測試步驟：
1. 選擇一張對話截圖
2. 點擊「開始分析」
3. 應立即跳轉到 `AnalysisPage`
4. 應顯示全螢幕測試廣告
5. 觀看完整廣告直到可以關閉
6. 關閉廣告後，等待分析完成
7. 自動跳轉到 `ResultPage` 顯示分析結果

錯誤測試：
1. 上傳非對話截圖或無效圖片
2. 應在分析過程中檢測到錯誤
3. 應立即顯示錯誤對話框
4. 點擊「確定」後返回 HomePage

## 注意事項

1. **首次載入**：App 啟動時會自動預載第一個廣告，如果網路較慢可能需要等待
2. **廣告載入失敗**：如果廣告載入失敗，會顯示錯誤訊息
3. **測試環境**：確保使用測試裝置或測試 ID，避免帳號被停權
4. **上線前準備**：
   - 在 AdMob 控制台創建正式 App 和廣告單元
   - 替換所有測試 ID 為正式 ID
   - 更新 iOS Info.plist 和 Android AndroidManifest.xml
   - 更新 `ad_service.dart` 中的廣告單元 ID

## 後續優化建議

1. **廣告預載策略**：在 HomePage 就預載廣告，確保點擊分析時廣告已準備好
2. **廣告載入狀態指示**：在 HomePage 顯示廣告載入狀態（可選）
3. **錯誤重試機制**：廣告載入失敗時提供重試選項
4. **分析完成提示**：廣告看完但分析未完成時，顯示「正在完成分析...」提示
5. **多種廣告類型**：考慮在其他地方使用插頁廣告或橫幅廣告增加收益






