# éŒ¯èª¤è™•ç†ä¿®æ­£èªªæ˜

## æ›´æ–°æ—¥æœŸ
2025-12-10

## ä¿®æ­£å…§å®¹

### 1. å•é¡Œæè¿°

ä¹‹å‰çš„éŒ¯èª¤è™•ç†æœ‰ä»¥ä¸‹å•é¡Œï¼š
- âŒ éŒ¯èª¤ç™¼ç”Ÿæ™‚ï¼Œå»£å‘Šç¹¼çºŒæ’­æ”¾
- âŒ éŒ¯èª¤è¨Šæ¯æ¨£å¼ä¸ç¬¦åˆ Figma è¨­è¨ˆ
- âŒ éŒ¯èª¤ç™¼ç”Ÿæ™‚æ²’æœ‰ç«‹å³è¿”å› HomePage

### 2. ä¿®æ­£æ–¹æ¡ˆ

#### 2.1 AdService æ”¯æ´ä¸­æ–·å»£å‘Šæ’­æ”¾

**æª”æ¡ˆï¼š** `lib/src/services/ad_service.dart`

**æ–°å¢åŠŸèƒ½ï¼š**
- æ–°å¢ `_onAdInterrupted` å›èª¿
- æ–°å¢ `interruptAd()` æ–¹æ³•ç”¨æ–¼ä¸­æ–·å»£å‘Šæ’­æ”¾
- åœ¨ `showRewardedAd()` ä¸­æ–°å¢ `onAdInterrupted` åƒæ•¸

```dart
/// ä¸­æ–·å»£å‘Šæ’­æ”¾ï¼ˆç”¨æ–¼éŒ¯èª¤è™•ç†ï¼‰
void interruptAd() {
  if (_isAdShowing && _rewardedAd != null) {
    debugPrint('AdService: ä¸­æ–·å»£å‘Šæ’­æ”¾');
    // èª¿ç”¨ä¸­æ–·å›èª¿
    _onAdInterrupted?.call();
    _onAdInterrupted = null;
    
    // é—œé–‰å»£å‘Š
    _isAdShowing = false;
  }
}
```

#### 2.2 æ›´æ–° ErrorDialog æ¨£å¼

**æª”æ¡ˆï¼š** `lib/src/widgets/error_dialog.dart`

**è¨­è¨ˆåƒè€ƒï¼š** [Figma - Error Message](https://www.figma.com/design/Z2YBZJO8AEbauRkU6YuwRQ/Flirt-Analysis?node-id=139-344)

**ä¸»è¦è®Šæ›´ï¼š**
- âœ… ç™½è‰²èƒŒæ™¯ï¼ˆåŸæœ¬æ˜¯æ·±ç°è‰²ï¼‰
- âœ… åœ“è§’ 16px
- âœ… é™°å½±æ•ˆæœ
- âœ… æ¬¡è¦æŒ‰éˆ•æ¨£å¼ï¼ˆç™½è‰²èƒŒæ™¯ + ç´…è‰²é‚Šæ¡†ï¼‰
- âœ… æ­£ç¢ºçš„å­—é«”å¤§å°å’Œé–“è·

**æ¨£å¼å°æ¯”ï¼š**

| å…ƒç´  | èˆŠæ¨£å¼ | æ–°æ¨£å¼ï¼ˆFigmaï¼‰ |
|------|--------|----------------|
| èƒŒæ™¯è‰² | `#2C2C2E` (æ·±ç°) | `#FFFFFF` (ç™½è‰²) |
| åœ“è§’ | 14px | 16px |
| æ¨™é¡Œå­—é«” | 17px, 600 | 22px, 700 |
| å…§å®¹å­—é«” | 13px, 400 | 17px, 400 |
| æŒ‰éˆ•æ¨£å¼ | é€æ˜èƒŒæ™¯ + ç´…è‰²æ–‡å­— | ç™½è‰²èƒŒæ™¯ + ç´…è‰²é‚Šæ¡† + ç´…è‰²æ–‡å­— |
| é–“è· | è¼ƒå° | 24px padding, 16px/40px gaps |

#### 2.3 HomePage éŒ¯èª¤è™•ç†é‚è¼¯

**æª”æ¡ˆï¼š** `lib/src/pages/home_page.dart`

**ä¸»è¦è®Šæ›´ï¼š**

1. **ç›£è½åˆ†æéŒ¯èª¤ä¸¦ä¸­æ–·å»£å‘Šï¼š**
```dart
ref.listen<AnalysisState>(analysisProvider, (previous, next) {
  if (next.hasError && mounted && !errorState.hasError) {
    debugPrint('HomePage: åµæ¸¬åˆ°åˆ†æéŒ¯èª¤ï¼Œä¸­æ–·å»£å‘Šæ’­æ”¾');
    
    // ä¸­æ–·å»£å‘Šæ’­æ”¾
    final adService = AdService();
    if (adService.isAdShowing) {
      adService.interruptAd();
    }
    
    // é¡¯ç¤ºéŒ¯èª¤
    ref.read(errorProvider.notifier).showError(
      next.errorMessage ?? AppLocalizations.of(context)!.errorAnalysisFailed,
      title: AppLocalizations.of(context)!.errorTitle,
    );
    
    setState(() {
      _isAnalyzing = false;
    });
  }
});
```

2. **å»£å‘Šä¸­æ–·è™•ç†ï¼š**
```dart
bool adInterrupted = false;

await adService.showRewardedAd(
  onUserEarnedReward: () {
    // åªæœ‰åœ¨å»£å‘Šæ²’è¢«ä¸­æ–·æ™‚æ‰è·³è½‰
    if (mounted && !adInterrupted) {
      context.push(...);
    }
  },
  onAdInterrupted: () {
    debugPrint('å»£å‘Šè¢«ä¸­æ–·');
    adInterrupted = true;
  },
);
```

#### 2.4 ResultPage éŒ¯èª¤è™•ç†

**æª”æ¡ˆï¼š** `lib/src/pages/result_page.dart`

**ä¸»è¦è®Šæ›´ï¼š**

å¦‚æœåœ¨ ResultPage åµæ¸¬åˆ°éŒ¯èª¤ï¼Œç«‹å³è¿”å› HomePageï¼š

```dart
ref.listen<AnalysisState>(analysisProvider, (previous, next) {
  if (next.hasError && mounted) {
    debugPrint('ResultPage: åµæ¸¬åˆ°åˆ†æéŒ¯èª¤ï¼Œè¿”å› HomePage');
    // è¿”å› HomePage
    context.pop();
  }
});
```

---

## éŒ¯èª¤è™•ç†æµç¨‹

### æ­£å¸¸æµç¨‹ï¼ˆç„¡éŒ¯èª¤ï¼‰

```
1. HomePage: é»æ“Šã€Œé–‹å§‹åˆ†æã€
   â†“
2. é–‹å§‹èƒŒæ™¯åˆ†æï¼ˆanalysisProvider.analyze()ï¼‰
   â†“
3. æ’­æ”¾å…¨è¢å¹•å»£å‘Š
   â†“
4. ç”¨æˆ¶çœ‹å®Œå»£å‘Š
   â†“
5. è·³è½‰åˆ° ResultPage
   â†“
6. é¡¯ç¤ºåˆ†æçµæœ
```

### éŒ¯èª¤æµç¨‹ï¼ˆåˆ†æå¤±æ•—ï¼‰

```
1. HomePage: é»æ“Šã€Œé–‹å§‹åˆ†æã€
   â†“
2. é–‹å§‹èƒŒæ™¯åˆ†æï¼ˆanalysisProvider.analyze()ï¼‰
   â†“
3. æ’­æ”¾å…¨è¢å¹•å»£å‘Š
   â†“
4. åˆ†æå¤±æ•—ï¼ˆAPI éŒ¯èª¤ã€ç¶²è·¯éŒ¯èª¤ç­‰ï¼‰
   â†“
5. HomePage åµæ¸¬åˆ°éŒ¯èª¤
   â”œâ”€ ä¸­æ–·å»£å‘Šæ’­æ”¾ï¼ˆadService.interruptAd()ï¼‰
   â”œâ”€ é¡¯ç¤ºéŒ¯èª¤é®ç½©ï¼ˆé»‘è‰²åŠé€æ˜ï¼‰
   â””â”€ é¡¯ç¤ºéŒ¯èª¤å°è©±æ¡†ï¼ˆç™½è‰²ã€Figma è¨­è¨ˆï¼‰
   â†“
6. ç”¨æˆ¶é»æ“Šã€Œç¢ºå®šã€
   â†“
7. æ¸…é™¤éŒ¯èª¤ï¼Œé—œé–‰é®ç½©
   â†“
8. åœç•™åœ¨ HomePage
```

### éŒ¯èª¤æµç¨‹ï¼ˆå»£å‘Šè¼‰å…¥å¤±æ•—ï¼‰

```
1. HomePage: é»æ“Šã€Œé–‹å§‹åˆ†æã€
   â†“
2. æª¢æŸ¥å»£å‘Šæ˜¯å¦å·²è¼‰å…¥
   â†“
3. å»£å‘Šæœªè¼‰å…¥
   â†“
4. é¡¯ç¤ºéŒ¯èª¤é®ç½©å’Œå°è©±æ¡†
   â†“
5. ç”¨æˆ¶é»æ“Šã€Œç¢ºå®šã€
   â†“
6. åœç•™åœ¨ HomePage
```

---

## è¦–è¦ºæ•ˆæœ

### éŒ¯èª¤é®ç½© + å°è©±æ¡†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                 â”‚
â”‚  [HomePage èƒŒæ™¯ - æ¨¡ç³Š/è®Šæš—]    â”‚
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                           â”‚  â”‚
â”‚  â”‚  éŒ¯èª¤æ¨™é¡Œ                 â”‚  â”‚
â”‚  â”‚                           â”‚  â”‚
â”‚  â”‚  éŒ¯èª¤è¨Šæ¯å…§å®¹é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ â”‚  â”‚
â”‚  â”‚  å…§å®¹é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯å…§å®¹é¡¯ç¤º â”‚  â”‚
â”‚  â”‚  éŒ¯èª¤è¨Šæ¯å…§å®¹é¡¯ç¤º         â”‚  â”‚
â”‚  â”‚                           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚      ç¢ºå®š           â”‚  â”‚  â”‚ â† ç™½è‰²èƒŒæ™¯ + ç´…è‰²é‚Šæ¡†
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¨­è¨ˆç‰¹é»ï¼š**
- âœ… é»‘è‰²åŠé€æ˜é®ç½©ï¼ˆ`Colors.black.withOpacity(0.5)`ï¼‰
- âœ… ç™½è‰²å°è©±æ¡†èƒŒæ™¯
- âœ… åœ“è§’ 16px
- âœ… é™°å½±æ•ˆæœ
- âœ… æ¬¡è¦æŒ‰éˆ•æ¨£å¼ï¼ˆç´…è‰²é‚Šæ¡†ï¼‰

---

## æ¸¬è©¦æª¢æŸ¥æ¸…å–®

### åŸºæœ¬éŒ¯èª¤è™•ç†

- [ ] **å»£å‘Šè¼‰å…¥å¤±æ•—**
  - é—œé–‰ç¶²è·¯æˆ–ä½¿ç”¨éŒ¯èª¤çš„å»£å‘Š ID
  - é æœŸï¼šé¡¯ç¤ºéŒ¯èª¤å°è©±æ¡†ï¼Œåœç•™åœ¨ HomePage
  
- [ ] **åˆ†æ API å¤±æ•—**
  - ä½¿ç”¨ç„¡æ•ˆçš„åœ–ç‰‡æˆ– API key
  - é æœŸï¼šå»£å‘Šè¢«ä¸­æ–·ï¼Œé¡¯ç¤ºéŒ¯èª¤å°è©±æ¡†ï¼Œåœç•™åœ¨ HomePage

- [ ] **ç¶²è·¯éŒ¯èª¤**
  - åœ¨åˆ†æéç¨‹ä¸­é—œé–‰ç¶²è·¯
  - é æœŸï¼šå»£å‘Šè¢«ä¸­æ–·ï¼Œé¡¯ç¤ºéŒ¯èª¤å°è©±æ¡†ï¼Œåœç•™åœ¨ HomePage

### éŒ¯èª¤å°è©±æ¡†æ¨£å¼

- [ ] **èƒŒæ™¯è‰²**ï¼šç™½è‰²ï¼ˆä¸æ˜¯æ·±ç°è‰²ï¼‰
- [ ] **åœ“è§’**ï¼š16px
- [ ] **é™°å½±**ï¼šæœ‰é™°å½±æ•ˆæœ
- [ ] **æ¨™é¡Œå­—é«”**ï¼š22px, Bold (700)
- [ ] **å…§å®¹å­—é«”**ï¼š17px, Regular (400)
- [ ] **æŒ‰éˆ•æ¨£å¼**ï¼šç™½è‰²èƒŒæ™¯ + ç´…è‰²é‚Šæ¡† + ç´…è‰²æ–‡å­—
- [ ] **é®ç½©**ï¼šé»‘è‰²åŠé€æ˜ï¼ˆ0.5 opacityï¼‰

### éŒ¯èª¤è™•ç†æµç¨‹

- [ ] éŒ¯èª¤ç™¼ç”Ÿæ™‚ï¼Œå»£å‘Šç«‹å³è¢«ä¸­æ–·
- [ ] éŒ¯èª¤å°è©±æ¡†é¡¯ç¤ºåœ¨ HomePage ä¸Š
- [ ] é»æ“Šã€Œç¢ºå®šã€å¾Œï¼ŒéŒ¯èª¤é®ç½©æ¶ˆå¤±
- [ ] åœç•™åœ¨ HomePageï¼Œå¯ä»¥é‡æ–°é¸æ“‡åœ–ç‰‡
- [ ] å¦‚æœåœ¨ ResultPage ç™¼ç”ŸéŒ¯èª¤ï¼Œè‡ªå‹•è¿”å› HomePage

### é‚Šç•Œæƒ…æ³

- [ ] é€£çºŒé»æ“Šã€Œé–‹å§‹åˆ†æã€ä¸æœƒé‡è¤‡åˆ†æ
- [ ] éŒ¯èª¤é¡¯ç¤ºæ™‚ï¼Œç„¡æ³•é»æ“ŠèƒŒå¾Œçš„ UI
- [ ] éŒ¯èª¤æ¸…é™¤å¾Œï¼Œå¯ä»¥æ­£å¸¸é‡æ–°åˆ†æ
- [ ] å¤šæ¬¡éŒ¯èª¤ä¸æœƒç–ŠåŠ é¡¯ç¤º

---

## æŠ€è¡“ç´°ç¯€

### 1. ç‚ºä»€éº¼éœ€è¦ `adInterrupted` æ¨™è¨˜ï¼Ÿ

```dart
bool adInterrupted = false;

await adService.showRewardedAd(
  onUserEarnedReward: () {
    if (mounted && !adInterrupted) {  // â† æª¢æŸ¥æ˜¯å¦è¢«ä¸­æ–·
      context.push(...);
    }
  },
  onAdInterrupted: () {
    adInterrupted = true;  // â† è¨­å®šæ¨™è¨˜
  },
);
```

**åŸå› ï¼š**
- å»£å‘Šè¢«ä¸­æ–·å¾Œï¼Œ`onUserEarnedReward` å¯èƒ½ä»æœƒè¢«èª¿ç”¨
- ä½¿ç”¨æ¨™è¨˜é˜²æ­¢éŒ¯èª¤ç™¼ç”Ÿå¾Œä»è·³è½‰åˆ° ResultPage

### 2. ç‚ºä»€éº¼éœ€è¦æª¢æŸ¥ `!errorState.hasError`ï¼Ÿ

```dart
if (next.hasError && mounted && !errorState.hasError) {
  // é¡¯ç¤ºéŒ¯èª¤
}
```

**åŸå› ï¼š**
- é˜²æ­¢é‡è¤‡é¡¯ç¤ºéŒ¯èª¤
- å¦‚æœå·²ç¶“æœ‰éŒ¯èª¤åœ¨é¡¯ç¤ºï¼Œä¸è¦ç–ŠåŠ æ–°éŒ¯èª¤

### 3. ç‚ºä»€éº¼ ResultPage è¦è¿”å› HomePageï¼Ÿ

```dart
ref.listen<AnalysisState>(analysisProvider, (previous, next) {
  if (next.hasError && mounted) {
    context.pop();  // â† è¿”å› HomePage
  }
});
```

**åŸå› ï¼š**
- ResultPage åªæ‡‰è©²é¡¯ç¤ºæˆåŠŸçš„åˆ†æçµæœ
- éŒ¯èª¤æ‡‰è©²åœ¨ HomePage è™•ç†
- ä¿æŒæµç¨‹ç°¡å–®æ¸…æ™°

---

## èˆ‡è¨­è¨ˆçš„å°æ‡‰

### Figma è¨­è¨ˆç¯€é»
- **Node ID:** 139-344
- **URL:** https://www.figma.com/design/Z2YBZJO8AEbauRkU6YuwRQ/Flirt-Analysis?node-id=139-344

### è¨­è¨ˆå…ƒç´ å°æ‡‰

| Figma å…ƒç´  | Flutter å¯¦ä½œ |
|-----------|-------------|
| é»‘è‰²åŠé€æ˜é®ç½© | `Container(color: Colors.black.withOpacity(0.5))` |
| ç™½è‰²å°è©±æ¡† | `Container(color: Colors.white)` |
| åœ“è§’ 16px | `BorderRadius.circular(16)` |
| æ¨™é¡Œ (Title2/Emphasized) | `fontSize: 22, fontWeight: FontWeight.w700` |
| å…§å®¹ (Body/Regular) | `fontSize: 17, fontWeight: FontWeight.w400` |
| æ¬¡è¦æŒ‰éˆ• | `OutlinedButton` with `BorderSide(color: AppColors.primary)` |

---

## ç¸½çµ

### âœ… å·²ä¿®æ­£

1. **å»£å‘Šä¸­æ–·åŠŸèƒ½**
   - AdService æ–°å¢ `interruptAd()` æ–¹æ³•
   - HomePage ç›£è½éŒ¯èª¤ä¸¦ä¸­æ–·å»£å‘Š

2. **éŒ¯èª¤å°è©±æ¡†æ¨£å¼**
   - æ ¹æ“š Figma è¨­è¨ˆæ›´æ–°æ¨£å¼
   - ç™½è‰²èƒŒæ™¯ã€æ­£ç¢ºçš„å­—é«”å’Œé–“è·

3. **éŒ¯èª¤è™•ç†æµç¨‹**
   - éŒ¯èª¤ç™¼ç”Ÿæ™‚ç«‹å³ä¸­æ–·å»£å‘Š
   - é¡¯ç¤ºéŒ¯èª¤é®ç½©å’Œå°è©±æ¡†
   - åœç•™åœ¨ HomePage

4. **ResultPage éŒ¯èª¤è™•ç†**
   - åµæ¸¬åˆ°éŒ¯èª¤æ™‚è‡ªå‹•è¿”å› HomePage

### ğŸ¯ é—œéµæ”¹é€²

- âœ… ç¬¦åˆ Figma è¨­è¨ˆ
- âœ… éŒ¯èª¤è™•ç†æµç¨‹æ¸…æ™°
- âœ… ç”¨æˆ¶é«”é©—æµæš¢
- âœ… é˜²æ­¢éŒ¯èª¤ç–ŠåŠ 
- âœ… ç¨‹å¼ç¢¼æ˜“æ–¼ç¶­è­·

---

**ä¿®æ­£å®Œæˆï¼** ğŸ‰




